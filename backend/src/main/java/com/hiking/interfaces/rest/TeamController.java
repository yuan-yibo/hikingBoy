package com.hiking.interfaces.rest;

import com.hiking.application.team.dto.*;
import com.hiking.application.team.service.TeamApplicationService;
import com.hiking.interfaces.rest.common.ApiResponse;
import lombok.RequiredArgsConstructor;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

/**
 * 团队接口
 */
@RestController
@RequestMapping("/v1/teams")
@RequiredArgsConstructor
public class TeamController {

    private final TeamApplicationService teamApplicationService;

    /**
     * 创建团队
     */
    @PostMapping
    public ApiResponse<TeamDTO> createTeam(
            @RequestHeader("X-User-Id") String visitorId,
            @RequestBody CreateTeamRequest request) {
        TeamDTO team = teamApplicationService.createTeam(visitorId, request);
        return ApiResponse.success(team);
    }

    /**
     * 获取我的团队列表
     */
    @GetMapping
    public ApiResponse<List<TeamDTO>> getMyTeams(@RequestHeader("X-User-Id") String visitorId) {
        List<TeamDTO> teams = teamApplicationService.getMyTeams(visitorId);
        return ApiResponse.success(teams);
    }
















































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































    /**
     * 获取团队详情
     */
    @GetMapping("/{id}")
    public ApiResponse<TeamDTO> getTeam(
            @PathVariable Long id,
            @RequestHeader("X-User-Id") String visitorId) {
        TeamDTO team = teamApplicationService.getTeam(id, visitorId);
        return ApiResponse.success(team);
    }

    /**
     * 更新团队信息
     */
    @PutMapping("/{id}")
    public ApiResponse<TeamDTO> updateTeam(
            @PathVariable Long id,
            @RequestHeader("X-User-Id") String visitorId,
            @RequestBody UpdateTeamRequest request) {
        TeamDTO team = teamApplicationService.updateTeam(id, visitorId, request);
        return ApiResponse.success(team);
    }

    /**
     * 解散团队
     */
    @DeleteMapping("/{id}")
    public ApiResponse<Void> deleteTeam(
            @PathVariable Long id,
            @RequestHeader("X-User-Id") String visitorId) {
        teamApplicationService.deleteTeam(id, visitorId);
        return ApiResponse.success(null);
    }

    /**
     * 通过邀请码加入团队
     */
    @PostMapping("/join")
    public ApiResponse<TeamDTO> joinByInviteCode(
            @RequestHeader("X-User-Id") String visitorId,
            @RequestBody JoinTeamRequest request) {
        TeamDTO team = teamApplicationService.joinByInviteCode(visitorId, request);
        return ApiResponse.success(team);
    }

    /**
     * 申请加入团队
     */
    @PostMapping("/{id}/apply")
    public ApiResponse<Void> applyToJoin(
            @PathVariable Long id,
            @RequestHeader("X-User-Id") String visitorId) {
        teamApplicationService.applyToJoin(id, visitorId);
        return ApiResponse.success(null);
    }

    /**
     * 获取团队成员列表
     */
    @GetMapping("/{id}/members")
    public ApiResponse<List<TeamMemberDTO>> getTeamMembers(
            @PathVariable Long id,
            @RequestHeader("X-User-Id") String visitorId) {
        List<TeamMemberDTO> members = teamApplicationService.getTeamMembers(id, visitorId);
        return ApiResponse.success(members);
    }

    /**
     * 获取待审批的申请列表
     */
    @GetMapping("/{id}/applications")
    public ApiResponse<List<TeamMemberDTO>> getPendingApplications(
            @PathVariable Long id,
            @RequestHeader("X-User-Id") String visitorId) {
        List<TeamMemberDTO> applications = teamApplicationService.getPendingApplications(id, visitorId);
        return ApiResponse.success(applications);
    }

    /**
     * 审批加入申请
     */
    @PutMapping("/{id}/members/{memberId}/approve")
    public ApiResponse<Void> approveApplication(
            @PathVariable Long id,
            @PathVariable Long memberId,
            @RequestHeader("X-User-Id") String visitorId,
            @RequestBody Map<String, Boolean> body) {
        boolean approve = body.getOrDefault("approve", false);
        teamApplicationService.approveApplication(id, memberId, visitorId, approve);
        return ApiResponse.success(null);
    }

    /**
     * 移除成员
     */
    @DeleteMapping("/{id}/members/{memberId}")
    public ApiResponse<Void> removeMember(
            @PathVariable Long id,
            @PathVariable Long memberId,
            @RequestHeader("X-User-Id") String visitorId) {
        teamApplicationService.removeMember(id, memberId, visitorId);
        return ApiResponse.success(null);
    }

    /**
     * 退出团队
     */
    @PostMapping("/{id}/leave")
    public ApiResponse<Void> leaveTeam(
            @PathVariable Long id,
            @RequestHeader("X-User-Id") String visitorId) {
        teamApplicationService.leaveTeam(id, visitorId);
        return ApiResponse.success(null);
    }

    /**
     * 重新生成邀请码
     */
    @PostMapping("/{id}/regenerate-invite-code")
    public ApiResponse<Map<String, String>> regenerateInviteCode(
            @PathVariable Long id,
            @RequestHeader("X-User-Id") String visitorId) {
        String inviteCode = teamApplicationService.regenerateInviteCode(id, visitorId);
        return ApiResponse.success(Map.of("inviteCode", inviteCode));
    }
}
